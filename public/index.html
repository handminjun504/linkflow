<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LinkFlow</title>
  <meta name="theme-color" content="#4DA8DA" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="manifest" href="/manifest.json" />
  <link rel="icon" type="image/png" href="/icons/icon-192.png" />
  <link rel="apple-touch-icon" href="/icons/icon-192.png" />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.6.0/fonts/remixicon.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="/css/style.css" />
</head>
<body>

  <!-- ══════ Login Screen ══════ -->
  <div id="login-screen" class="screen">
    <div class="login-container">
      <div class="login-logo">
        <i class="ri-link-m"></i>
        <h1>LinkFlow</h1>
        <p>업무 서비스 통합 관리</p>
      </div>
      <form id="login-form" autocomplete="off">
        <div class="input-group">
          <i class="ri-user-line"></i>
          <input type="text" id="login-username" placeholder="아이디" autocomplete="username" required />
        </div>
        <div class="input-group">
          <i class="ri-lock-line"></i>
          <input type="password" id="login-password" placeholder="비밀번호" autocomplete="current-password" required />
        </div>
        <label class="checkbox-label">
          <input type="checkbox" id="login-remember" />
          <span>이 PC 기억하기 (자동 로그인)</span>
        </label>
        <button type="submit" class="btn btn-primary btn-full" id="login-btn">로그인</button>
        <div id="login-error" class="error-msg hidden"></div>
      </form>
      <div id="setup-section" class="hidden">
        <div class="divider"><span>최초 설정</span></div>
        <form id="setup-form" autocomplete="off">
          <div class="input-group"><i class="ri-admin-line"></i><input type="text" id="setup-username" placeholder="관리자 아이디" autocomplete="username" required /></div>
          <div class="input-group"><i class="ri-lock-line"></i><input type="password" id="setup-password" placeholder="관리자 비밀번호" autocomplete="new-password" required /></div>
          <div class="input-group"><i class="ri-user-heart-line"></i><input type="text" id="setup-display" placeholder="표시 이름" required /></div>
          <button type="submit" class="btn btn-accent btn-full">관리자 계정 생성</button>
        </form>
      </div>
    </div>
  </div>

  <!-- ══════ Dashboard Screen ══════ -->
  <div id="dashboard-screen" class="screen hidden">
    <header class="app-header">
      <div class="header-left">
        <i class="ri-link-m header-logo-icon"></i>
        <span class="header-title">LinkFlow</span>
      </div>
      <div class="header-center">
        <div class="search-box" id="search-box-wrap">
          <i class="ri-search-line"></i>
          <input type="text" id="search-input" placeholder="검색..." />
        </div>
      </div>
      <div class="header-right">
        <div class="ext-toolbar" id="ext-toolbar" style="display:none"></div>
        <button class="icon-btn" id="btn-add-bookmark" title="북마크 추가"><i class="ri-add-circle-line"></i></button>
        <button class="icon-btn" id="btn-settings" title="설정"><i class="ri-settings-3-line"></i></button>
        <button class="icon-btn" id="btn-admin" title="관리자" style="display:none"><i class="ri-admin-line"></i></button>
        <div class="user-badge" id="user-badge">
          <span id="user-display-name"></span>
          <i class="ri-arrow-down-s-line"></i>
        </div>
        <div class="user-dropdown hidden" id="user-dropdown">
          <button id="btn-change-pw"><i class="ri-key-line"></i> 비밀번호 변경</button>
          <button id="btn-logout"><i class="ri-logout-box-line"></i> 로그아웃</button>
        </div>
      </div>
    </header>

    <nav class="main-tab-bar" id="main-tab-bar">
      <button class="main-tab active" data-tab="bookmarks"><i class="ri-bookmark-line"></i><span>북마크</span></button>
      <button class="main-tab" data-tab="calendar"><i class="ri-calendar-line"></i><span>캘린더</span></button>
      <button class="main-tab" data-tab="memos"><i class="ri-sticky-note-line"></i><span>메모</span></button>
      <div class="tab-divider" id="tab-divider"></div>
      <div id="dynamic-tabs"></div>
      <button class="main-tab tab-add-btn" id="btn-add-tab" title="새 탭"><i class="ri-add-line"></i></button>
    </nav>

    <!-- Tab: Bookmarks -->
    <main class="tab-content active" id="tab-bookmarks">
      <div class="category-tabs" id="category-tabs">
        <button class="cat-tab active" data-cat="all"><i class="ri-apps-line"></i> 전체</button>
      </div>
      <div class="bookmarks-grid" id="bookmarks-grid"></div>
      <div class="empty-state hidden" id="empty-state">
        <i class="ri-bookmark-line"></i>
        <p>등록된 북마크가 없습니다</p>
        <button class="btn btn-primary" id="btn-empty-add"><i class="ri-add-line"></i> 첫 번째 북마크 추가</button>
      </div>
    </main>

    <!-- Tab: Calendar (with task sidebar) -->
    <main class="tab-content" id="tab-calendar">
      <div class="calendar-layout">
        <!-- Task Sidebar -->
        <aside class="task-sidebar" id="task-sidebar">
          <div class="task-sidebar-header">
            <h3><i class="ri-list-check-2"></i> 이번 주 업무</h3>
          </div>
          <div class="task-sidebar-body" id="task-list"></div>
        </aside>
        <!-- Calendar Main -->
        <div class="calendar-main">
          <div class="calendar-header">
            <button class="icon-btn" id="cal-prev"><i class="ri-arrow-left-s-line"></i></button>
            <h2 id="cal-month-title"></h2>
            <button class="icon-btn" id="cal-next"><i class="ri-arrow-right-s-line"></i></button>
            <button class="btn btn-sm btn-outline" id="cal-today">오늘</button>
          </div>
          <div class="calendar-weekdays">
            <span class="wd sun">일</span><span class="wd">월</span><span class="wd">화</span>
            <span class="wd">수</span><span class="wd">목</span><span class="wd">금</span>
            <span class="wd sat">토</span>
          </div>
          <div class="calendar-grid" id="calendar-grid"></div>
        </div>
      </div>
    </main>

    <!-- Tab: Memos -->
    <main class="tab-content" id="tab-memos">
      <div class="memos-header">
        <h2><i class="ri-sticky-note-line"></i> 메모</h2>
        <button class="btn btn-primary btn-sm" id="btn-add-memo"><i class="ri-add-line"></i> 새 메모</button>
      </div>
      <div class="memos-grid" id="memos-grid"></div>
      <div class="empty-state hidden" id="memo-empty-state">
        <i class="ri-sticky-note-line"></i>
        <p>메모가 없습니다</p>
        <button class="btn btn-primary" id="btn-memo-empty-add"><i class="ri-add-line"></i> 첫 번째 메모 작성</button>
      </div>
    </main>

    <!-- ══════ Dynamic Tab Frames ══════ -->
    <div id="dynamic-tab-frames"></div>
  </div>

  <!-- ══════ Settings Panel ══════ -->
  <div id="settings-panel" class="side-panel hidden">
    <div class="panel-header">
      <h2><i class="ri-settings-3-line"></i> 설정</h2>
      <button class="icon-btn" id="close-settings"><i class="ri-close-line"></i></button>
    </div>
    <div class="panel-body">
      <div class="setting-group">
        <h3>프로필</h3>
        <div class="input-group"><i class="ri-user-line"></i><input type="text" id="setting-display-name" placeholder="표시 이름" /></div>
        <button class="btn btn-primary btn-sm" id="btn-save-profile">저장</button>
      </div>
      <form class="setting-group" id="lock-settings-form" autocomplete="off" onsubmit="return false">
        <h3>화면 잠금</h3>
        <label class="toggle-label">
          <span>자동 잠금</span>
          <input type="checkbox" id="setting-lock-enabled" class="toggle-input" />
          <span class="toggle-slider"></span>
        </label>
        <div id="lock-options">
          <label class="field-label">잠금 시간 (분)</label>
          <select id="setting-lock-timeout" class="select-input">
            <option value="60">1분</option><option value="180">3분</option><option value="300" selected>5분</option>
            <option value="600">10분</option><option value="900">15분</option>
          </select>
          <label class="field-label">잠금 해제 PIN (숫자 1~4자리)</label>
          <div class="input-group"><i class="ri-lock-password-line"></i><input type="password" id="setting-pin" maxlength="4" pattern="[0-9]*" inputmode="numeric" placeholder="PIN 입력" autocomplete="off" /></div>
        </div>
        <button class="btn btn-primary btn-sm" id="btn-save-lock">저장</button>
      </form>
      <div class="setting-group" id="pw-manage-section" style="display:none">
        <h3><i class="ri-key-2-line" style="color:var(--primary)"></i> 저장된 비밀번호</h3>
        <div id="saved-pw-list"></div>
      </div>
      <div class="setting-group" id="ext-manage-section" style="display:none">
        <h3><i class="ri-puzzle-line" style="color:var(--primary)"></i> 확장 프로그램</h3>
        <p style="font-size:12px;color:var(--text-muted);margin-bottom:8px">Chrome 웹 스토어에서 다운로드한 확장 프로그램의 압축 해제 폴더를 불러올 수 있습니다.</p>
        <button class="btn btn-primary btn-sm" id="btn-load-extension"><i class="ri-add-line"></i> 확장 프로그램 추가</button>
        <div id="ext-list" style="margin-top:8px"></div>
      </div>
      <div class="setting-group">
        <h3>카테고리 관리</h3>
        <div id="category-list" class="category-manage-list"></div>
        <button class="btn btn-outline btn-sm" id="btn-add-category"><i class="ri-add-line"></i> 카테고리 추가</button>
      </div>
      <div class="setting-group">
        <h3><i class="ri-history-line" style="color:var(--primary)"></i> 앱 정보</h3>
        <p id="app-version-display" style="font-size:12px;color:var(--text-muted);margin-bottom:8px"></p>
        <button class="btn btn-outline btn-sm" id="btn-update-history"><i class="ri-history-line"></i> 업데이트 이력</button>
      </div>
    </div>
  </div>

  <!-- ══════ Admin Panel ══════ -->
  <div id="admin-panel" class="side-panel hidden">
    <div class="panel-header">
      <h2><i class="ri-admin-line"></i> 관리자</h2>
      <button class="icon-btn" id="close-admin"><i class="ri-close-line"></i></button>
    </div>
    <div class="panel-body">
      <div class="setting-group">
        <h3>사용자 관리</h3>
        <button class="btn btn-primary btn-sm" id="btn-create-user"><i class="ri-user-add-line"></i> 사용자 생성</button>
        <div id="admin-user-list" class="user-list"></div>
      </div>
    </div>
  </div>

  <div id="panel-overlay" class="panel-overlay hidden"></div>

  <!-- ══════ Lock Screen ══════ -->
  <div id="lock-screen" class="lock-screen hidden">
    <form class="lock-content" id="lock-form" autocomplete="off" onsubmit="return false">
      <i class="ri-lock-line lock-icon"></i>
      <p>화면이 잠겼습니다</p>
      <p class="lock-sub">PIN을 입력하세요</p>
      <div class="pin-input-group"><input type="password" id="lock-pin-input" maxlength="4" inputmode="numeric" pattern="[0-9]*" autocomplete="off" autofocus /></div>
      <div id="lock-error" class="error-msg hidden"></div>
    </form>
  </div>

  <!-- ══════ Bookmark Modal ══════ -->
  <div id="bookmark-modal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="bookmark-modal-title">북마크 추가</h3>
        <button class="icon-btn modal-close" data-modal="bookmark-modal"><i class="ri-close-line"></i></button>
      </div>
      <form id="bookmark-form">
        <div class="input-group"><i class="ri-text"></i><input type="text" id="bm-title" placeholder="제목 (예: 경리나라)" required /></div>
        <div class="input-group"><i class="ri-link"></i><input type="url" id="bm-url" placeholder="URL (예: https://...)" required /></div>
        <div class="input-group"><i class="ri-file-text-line"></i><input type="text" id="bm-desc" placeholder="설명 (선택사항)" /></div>
        <div class="form-row">
          <div class="form-col">
            <label class="field-label">카테고리</label>
            <select id="bm-category" class="select-input"><option value="">없음</option></select>
          </div>
          <div class="form-col">
            <label class="field-label">유형</label>
            <select id="bm-type" class="select-input">
              <option value="web">🌐 웹사이트</option><option value="google_sheet">📗 구글시트</option><option value="server">🖥️ 서버</option>
              <option value="apps_script">📊 구글 앱스</option><option value="api">⚡ API</option><option value="dev_project">💻 개발/자동화</option><option value="other">📌 기타</option>
            </select>
          </div>
        </div>
        <div class="input-group"><i class="ri-heart-pulse-line"></i><input type="url" id="bm-health" placeholder="상태 확인 URL (선택사항)" /></div>
        <div class="input-group"><i class="ri-image-line"></i><input type="url" id="bm-icon" placeholder="아이콘 URL (선택사항)" /></div>
        <div class="form-row">
          <div class="form-col">
            <label class="field-label">열기 방식</label>
            <select id="bm-open-mode" class="select-input">
              <option value="auto">자동 (iframe 시도)</option>
              <option value="internal">항상 내장 브라우저</option>
              <option value="external">항상 새 탭</option>
            </select>
          </div>
        </div>
        <label class="checkbox-label hidden" id="bm-shared-wrap">
          <input type="checkbox" id="bm-shared" />
          <span>공통 북마크로 등록 (모든 사용자에게 표시)</span>
        </label>
        <input type="hidden" id="bm-edit-id" />
        <div class="modal-footer">
          <button type="button" class="btn btn-ghost" data-modal="bookmark-modal">취소</button>
          <button type="submit" class="btn btn-primary" id="bm-submit-btn">추가</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ══════ Category Modal ══════ -->
  <div id="category-modal" class="modal hidden">
    <div class="modal-content modal-sm">
      <div class="modal-header">
        <h3 id="category-modal-title">카테고리 추가</h3>
        <button class="icon-btn modal-close" data-modal="category-modal"><i class="ri-close-line"></i></button>
      </div>
      <form id="category-form">
        <div class="form-row">
          <div class="form-col" style="flex:0 0 80px"><label class="field-label">아이콘</label><input type="text" id="cat-icon" class="emoji-input" value="📁" /></div>
          <div class="form-col"><label class="field-label">이름</label><input type="text" id="cat-name" placeholder="카테고리 이름" required /></div>
        </div>
        <input type="hidden" id="cat-edit-id" />
        <div class="modal-footer">
          <button type="button" class="btn btn-ghost" data-modal="category-modal">취소</button>
          <button type="submit" class="btn btn-primary">저장</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ══════ Event Modal ══════ -->
  <div id="event-modal" class="modal hidden">
    <div class="modal-content modal-sm">
      <div class="modal-header">
        <h3 id="event-modal-title">일정 추가</h3>
        <button class="icon-btn modal-close" data-modal="event-modal"><i class="ri-close-line"></i></button>
      </div>
      <form id="event-form">
        <div class="input-group"><i class="ri-calendar-event-line"></i><input type="text" id="evt-title" placeholder="일정 제목" required /></div>
        <div class="form-row">
          <div class="form-col"><label class="field-label">날짜</label><input type="date" id="evt-date" class="select-input" required /></div>
          <div class="form-col"><label class="field-label">시간 (선택)</label><input type="time" id="evt-time" class="select-input" /></div>
        </div>
        <div class="form-row">
          <div class="form-col"><label class="field-label">종료일 (선택)</label><input type="date" id="evt-end-date" class="select-input" /></div>
          <div class="form-col"><label class="field-label">알림</label>
            <select id="evt-remind" class="select-input">
              <option value="">없음</option><option value="0">정시</option><option value="5">5분 전</option>
              <option value="10">10분 전</option><option value="15">15분 전</option><option value="30">30분 전</option><option value="60">1시간 전</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-col"><label class="field-label">반복</label>
            <select id="evt-recurrence" class="select-input">
              <option value="">없음</option><option value="daily">매일</option><option value="weekly">매주</option>
              <option value="monthly">매월</option><option value="yearly">매년</option>
            </select>
          </div>
          <div class="form-col" id="evt-recurrence-day-wrap" style="display:none">
            <label class="field-label">매월 반복일</label>
            <input type="number" id="evt-recurrence-day" class="select-input" min="1" max="31" placeholder="예: 22" />
          </div>
          <div class="form-col" id="evt-recurrence-end-wrap" style="display:none">
            <label class="field-label">반복 종료일</label>
            <input type="date" id="evt-recurrence-end" class="select-input" />
          </div>
        </div>
        <label class="checkbox-label" id="evt-skip-weekend-wrap" style="display:none;margin-bottom:8px">
          <input type="checkbox" id="evt-skip-weekend" checked />
          <span>주말/공휴일이면 직전 평일로 자동 조정</span>
        </label>
        <div class="input-group"><i class="ri-file-text-line"></i><input type="text" id="evt-desc" placeholder="메모 (선택)" /></div>
        <label class="checkbox-label" style="margin-bottom:8px">
          <input type="checkbox" id="evt-is-task" />
          <span>업무로 등록 (업무 목록에 표시)</span>
        </label>
        <div>
          <label class="field-label">색상</label>
          <div class="color-picker" id="evt-color-picker">
            <span class="color-dot active" data-color="#4DA8DA" style="background:#4DA8DA"></span>
            <span class="color-dot" data-color="#27AE60" style="background:#27AE60"></span>
            <span class="color-dot" data-color="#E74C3C" style="background:#E74C3C"></span>
            <span class="color-dot" data-color="#F39C12" style="background:#F39C12"></span>
            <span class="color-dot" data-color="#8E44AD" style="background:#8E44AD"></span>
            <span class="color-dot" data-color="#2C3E50" style="background:#2C3E50"></span>
          </div>
        </div>
        <input type="hidden" id="evt-edit-id" />
        <input type="hidden" id="evt-color" value="#4DA8DA" />
        <div class="modal-footer">
          <button type="button" class="btn btn-ghost" data-modal="event-modal">취소</button>
          <button type="button" class="btn btn-danger btn-sm hidden" id="evt-delete-btn">삭제</button>
          <button type="submit" class="btn btn-primary" id="evt-submit-btn">추가</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ══════ Memo Edit Modal ══════ -->
  <div id="memo-modal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="memo-modal-title">메모</h3>
        <button class="icon-btn modal-close" data-modal="memo-modal"><i class="ri-close-line"></i></button>
      </div>
      <form id="memo-form">
        <div class="input-group"><i class="ri-text"></i><input type="text" id="memo-title" placeholder="제목" /></div>
        <textarea id="memo-content" class="memo-textarea" rows="8" placeholder="내용을 입력하세요..."></textarea>
        <div>
          <label class="field-label">배경색</label>
          <div class="color-picker" id="memo-color-picker">
            <span class="color-dot active" data-color="#FFFFFF" style="background:#FFFFFF;border:1px solid #ddd"></span>
            <span class="color-dot" data-color="#FFF9C4" style="background:#FFF9C4"></span>
            <span class="color-dot" data-color="#C8E6C9" style="background:#C8E6C9"></span>
            <span class="color-dot" data-color="#BBDEFB" style="background:#BBDEFB"></span>
            <span class="color-dot" data-color="#F8BBD0" style="background:#F8BBD0"></span>
            <span class="color-dot" data-color="#E1BEE7" style="background:#E1BEE7"></span>
          </div>
        </div>
        <input type="hidden" id="memo-edit-id" />
        <input type="hidden" id="memo-color" value="#FFFFFF" />
        <div class="modal-footer">
          <button type="button" class="btn btn-ghost" data-modal="memo-modal">취소</button>
          <button type="button" class="btn btn-danger btn-sm hidden" id="memo-delete-btn">삭제</button>
          <button type="submit" class="btn btn-primary">저장</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ══════ User / PW / Confirm Modals ══════ -->
  <div id="user-modal" class="modal hidden">
    <div class="modal-content modal-sm">
      <div class="modal-header"><h3>사용자 생성</h3><button class="icon-btn modal-close" data-modal="user-modal"><i class="ri-close-line"></i></button></div>
      <form id="user-form">
        <div class="input-group"><i class="ri-user-line"></i><input type="text" id="new-user-id" placeholder="아이디" autocomplete="username" required /></div>
        <div class="input-group"><i class="ri-lock-line"></i><input type="password" id="new-user-pw" placeholder="초기 비밀번호" autocomplete="new-password" required /></div>
        <div class="input-group"><i class="ri-user-heart-line"></i><input type="text" id="new-user-name" placeholder="표시 이름" required /></div>
        <div class="modal-footer"><button type="button" class="btn btn-ghost" data-modal="user-modal">취소</button><button type="submit" class="btn btn-primary">생성</button></div>
      </form>
    </div>
  </div>
  <div id="pw-modal" class="modal hidden">
    <div class="modal-content modal-sm">
      <div class="modal-header"><h3>비밀번호 변경</h3><button class="icon-btn modal-close" data-modal="pw-modal"><i class="ri-close-line"></i></button></div>
      <form id="pw-form">
        <input type="text" name="username" autocomplete="username" class="hidden" aria-hidden="true" tabindex="-1" />
        <div class="input-group"><i class="ri-lock-line"></i><input type="password" id="pw-current" placeholder="현재 비밀번호" autocomplete="current-password" required /></div>
        <div class="input-group"><i class="ri-lock-password-line"></i><input type="password" id="pw-new" placeholder="새 비밀번호" autocomplete="new-password" required /></div>
        <div class="input-group"><i class="ri-lock-password-line"></i><input type="password" id="pw-confirm" placeholder="새 비밀번호 확인" autocomplete="new-password" required /></div>
        <div class="modal-footer"><button type="button" class="btn btn-ghost" data-modal="pw-modal">취소</button><button type="submit" class="btn btn-primary">변경</button></div>
      </form>
    </div>
  </div>
  <div id="confirm-dialog" class="modal hidden">
    <div class="modal-content modal-xs">
      <div class="modal-header"><h3 id="confirm-title">확인</h3></div>
      <p id="confirm-message" class="confirm-msg"></p>
      <div class="modal-footer"><button class="btn btn-ghost" id="confirm-cancel">취소</button><button class="btn btn-danger" id="confirm-ok">확인</button></div>
    </div>
  </div>

  <!-- ══════ Update History Modal ══════ -->
  <div id="update-history-modal" class="modal hidden">
    <div class="modal-content modal-lg">
      <div class="modal-header">
        <h3><i class="ri-history-line"></i> 업데이트 이력</h3>
        <button class="icon-btn modal-close" data-modal="update-history-modal"><i class="ri-close-line"></i></button>
      </div>
      <div id="update-history-body" class="update-history-body">
        <div class="update-loading"><i class="ri-loader-4-line ri-spin"></i> 이력을 불러오는 중...</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-modal="update-history-modal">확인</button>
      </div>
    </div>
  </div>

  <!-- ══════ Password Save Bar ══════ -->
  <div id="pw-save-bar" class="pw-save-bar hidden">
    <i class="ri-key-2-line"></i>
    <span>비밀번호를 저장하시겠습니까?</span>
    <span id="pw-save-domain" class="pw-save-domain"></span>
    <span id="pw-save-user" class="pw-save-user"></span>
    <div style="flex:1"></div>
    <button class="btn btn-primary btn-sm" id="pw-save-yes">저장</button>
    <button class="btn btn-ghost btn-sm" id="pw-save-no">안 함</button>
  </div>

  <div id="toast-container" class="toast-container"></div>

  <script src="/js/auth.js"></script>
  <script src="/js/ui.js"></script>
  <script src="/js/calendar.js"></script>
  <script src="/js/memos.js"></script>
  <script src="/js/app.js"></script>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(() => {});
    }
  </script>
</body>
</html>
